<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>保護者懇談 予約管理システム - 京進TOPΣ河瀬校</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", "Arial", sans-serif;
            background-color: #f5f5f7;
            color: #1d1d1f;
            line-height: 1.47059;
            font-weight: 400;
        }
        .header {
            background-color: #f5f5f7;
            border-bottom: 1px solid #d2d2d7;
        }
        .card {
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.06);
            margin-bottom: 16px;
            position: relative;
            overflow: hidden;
            background-color: #ffffff;
            border: 1px solid rgba(0,0,0,0.04);
        }
        .status-bar {
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }
        .status-tentative .status-bar {
            background-color: #FF9500;
        }
        .status-confirmed .status-bar {
            background-color: #34C759;
        }
        .status-canceled .status-bar {
            background-color: #8E8E93;
        }
        .status-label {
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            white-space: nowrap;
        }
        .status-tentative .status-label {
            background-color: rgba(255, 149, 0, 0.1);
            color: #BF720D;
        }
        .status-confirmed .status-label {
            background-color: rgba(52, 199, 89, 0.1);
            color: #248A3D;
        }
        .status-canceled .status-label {
            background-color: rgba(142, 142, 147, 0.1);
            color: #6D6D70;
        }
        .multiple-reservation-badge {
            background-color: #007AFF;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            position: absolute;
            top: 12px;
            right: 12px;
        }
        .action-btn {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            white-space: nowrap;
            text-align: center;
            transition: all 0.2s ease;
        }
        .btn-confirm {
            background-color: #34C759;
            color: white;
        }
        .btn-confirm:hover {
            background-color: #248A3D;
        }
        .btn-cancel {
            background-color: #FF3B30;
            color: white;
        }
        .btn-cancel:hover {
            background-color: #D70015;
        }
        .btn-restore {
            background-color: #007AFF;
            color: white;
        }
        .btn-restore:hover {
            background-color: #0051D5;
        }
        .filter-btn {
            background-color: white;
            border: 1px solid #d2d2d7;
            border-radius: 20px;
            padding: 6px 16px;
            font-size: 13px;
            font-weight: 400;
            cursor: pointer;
            margin-right: 8px;
            margin-bottom: 8px;
            transition: all 0.2s ease;
        }
        .filter-btn:hover {
            border-color: #007AFF;
        }
        .filter-btn.active {
            background-color: #007AFF;
            color: white;
            border-color: #007AFF;
        }
        .info-cell {
            vertical-align: top;
            padding-top: 10px;
        }
        .info-label {
            font-size: 11px;
            color: #86868B;
            margin-bottom: 2px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .info-value {
            font-size: 14px;
            font-weight: 400;
            color: #1d1d1f;
        }
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: #86868B;
        }
        .error {
            background-color: rgba(255, 59, 48, 0.1);
            border: 1px solid rgba(255, 59, 48, 0.3);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            color: #D70015;
        }
        .search-container {
            position: relative;
        }
        .search-input {
            width: 100%;
            border: 1px solid #d2d2d7;
            border-radius: 10px;
            padding: 12px 16px 12px 40px;
            font-size: 14px;
            background-color: white;
            transition: border-color 0.2s ease;
        }
        .search-input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        .search-icon {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: #86868B;
        }
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background-color: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07), 0 1px 3px rgba(0,0,0,0.06);
            border: 1px solid rgba(0,0,0,0.04);
        }
        .stat-number {
            font-size: 32px;
            font-weight: 600;
            color: #1d1d1f;
            margin-bottom: 4px;
        }
        .stat-label {
            font-size: 13px;
            color: #86868B;
            font-weight: 400;
        }
        .no-reservations {
            text-align: center;
            padding: 60px 20px;
            color: #86868B;
        }
        .no-reservations i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header py-6 px-6 flex justify-center items-center">
        <div class="text-center">
            <h1 class="text-2xl font-semibold text-1d1d1f mb-1">保護者懇談 予約管理システム</h1>
            <p class="text-sm text-86868B" id="schoolName">京進の中学・高校受験TOPΣ河瀬校</p>
        </div>
    </header>
    
    <!-- Stats Section -->
    <div class="px-6 pt-4">
        <div class="stats-container" id="statsContainer">
            <div class="stat-card">
                <div class="stat-number" id="totalReservations">-</div>
                <div class="stat-label">総予約数</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="tentativeReservations">-</div>
                <div class="stat-label">仮予約</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="confirmedReservations">-</div>
                <div class="stat-label">本予約</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="canceledReservations">-</div>
                <div class="stat-label">キャンセル</div>
            </div>
        </div>
    </div>
    
    <!-- Filters -->
    <div class="px-6 pt-4 pb-2">
        <div class="mb-4 flex flex-wrap items-center">
            <button class="filter-btn active" data-filter="all">すべて</button>
            <button class="filter-btn" data-filter="today">今日</button>
            <button class="filter-btn" data-filter="thisweek">今週</button>
            <button class="filter-btn" data-filter="tentative">仮予約のみ</button>
            <button class="filter-btn" data-filter="confirmed">本予約のみ</button>
            
            <div class="ml-auto flex items-center">
                <span class="text-sm mr-2 text-86868B">期間:</span>
                <input type="date" id="startDate" class="border border-d2d2d7 rounded-lg px-3 py-2 text-sm mr-2 bg-white">
                <span class="text-sm mx-1 text-86868B">〜</span>
                <input type="date" id="endDate" class="border border-d2d2d7 rounded-lg px-3 py-2 text-sm bg-white">
            </div>
        </div>
        <div class="mb-4">
            <div class="search-container">
                <i class="fas fa-search search-icon"></i>
                <input type="text" id="searchInput" placeholder="名前、クラス、電話番号で検索..." class="search-input">
            </div>
        </div>
    </div>
    
    <!-- Loading/Error States -->
    <div id="loadingState" class="loading">
        <i class="fas fa-spinner fa-spin mr-2"></i>
        予約データを読み込んでいます...
    </div>
    
    <div id="errorState" class="px-6" style="display: none;">
        <div class="error">
            <i class="fas fa-exclamation-triangle mr-2"></i>
            <span id="errorMessage">データの読み込みに失敗しました。</span>
            <button onclick="loadReservations()" class="ml-4 text-007AFF underline">再試行</button>
        </div>
    </div>
    
    <!-- Reservation List -->
    <div class="px-6 pb-8">
        <div id="reservationList">
            <!-- Reservations will be dynamically loaded here -->
        </div>
        
        <div id="noReservationsState" class="no-reservations" style="display: none;">
            <i class="fas fa-calendar-times"></i>
            <h3 class="text-lg font-medium mb-2">予約がありません</h3>
            <p>現在表示する予約データがありません。</p>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL = 'https://script.google.com/macros/s/AKfycbxWMp5v5Nn_Qvr97gbIwOqcKDXB-oN4tXJX1T2YfHAu1r5QNF80Orw50WvD_gmUM3e0qg/exec';
        
        // Global variables
        let allReservations = [];
        let filteredReservations = [];
        let systemSettings = {};
        
        // DOM elements
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const errorMessage = document.getElementById('errorMessage');
        const reservationList = document.getElementById('reservationList');
        const noReservationsState = document.getElementById('noReservationsState');
        const schoolNameElement = document.getElementById('schoolName');
        const searchInput = document.getElementById('searchInput');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadReservations();
            setupEventListeners();
        });
        
        function setupEventListeners() {
            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    applyFilters();
                });
            });
            
            // Search input
            searchInput.addEventListener('input', debounce(applyFilters, 300));
            
            // Date inputs
            startDateInput.addEventListener('change', applyFilters);
            endDateInput.addEventListener('change', applyFilters);
        }
        
        async function loadReservations() {
            try {
                showLoading();
                
                // First, get system settings
                const settingsResponse = await fetch(API_URL);
                const settingsData = await settingsResponse.json();
                
                if (!settingsData.success) {
                    throw new Error('設定データの取得に失敗しました');
                }
                
                systemSettings = settingsData.settings;
                schoolNameElement.textContent = systemSettings.schoolName;
                
                // Try to get reservations (this might need to be implemented in GAS)
                const reservationsResponse = await fetch(`${API_URL}?action=getReservations`);
                let reservationsData = [];
                
                try {
                    const resData = await reservationsResponse.json();
                    if (resData.success && resData.reservations) {
                        reservationsData = resData.reservations;
                    }
                } catch (e) {
                    // If reservation endpoint doesn't exist, create sample data
                    console.log('Reservation endpoint not available, using sample data');
                    reservationsData = generateSampleReservations();
                }
                
                allReservations = reservationsData;
                updateStats();
                applyFilters();
                hideLoading();
                
            } catch (error) {
                console.error('Error loading reservations:', error);
                showError(error.message);
            }
        }
        
        function generateSampleReservations() {
            // Generate sample reservation data for demonstration
            const sampleReservations = [
                {
                    id: '1',
                    date: '2025-06-25',
                    time: '14:00-14:40',
                    studentName: '山田 花子',
                    grade: '中3',
                    className: '3H',
                    meetingType: '対面',
                    participants: '父、母',
                    phone: '090-1234-5678',
                    notes: '志望校について相談したいです。特に数学の成績について話し合いたい。',
                    status: 'tentative',
                    reservationCount: 2,
                    timestamp: new Date('2025-06-20T10:00:00').getTime()
                },
                {
                    id: '2',
                    date: '2025-06-26',
                    time: '15:00-15:40',
                    studentName: '佐藤 太郎',
                    grade: '高1',
                    className: '1A',
                    meetingType: 'Zoom',
                    participants: '母、本人',
                    phone: '080-2345-6789',
                    notes: '部活と勉強の両立について相談したい。',
                    status: 'confirmed',
                    reservationCount: 1,
                    timestamp: new Date('2025-06-21T14:30:00').getTime()
                },
                {
                    id: '3',
                    date: '2025-06-24',
                    time: '16:00-16:40',
                    studentName: '鈴木 一郎',
                    grade: '中2',
                    className: '2K',
                    meetingType: '対面',
                    participants: '父',
                    phone: '070-3456-7890',
                    notes: '成績が下がってきているので相談したい。',
                    status: 'canceled',
                    reservationCount: 1,
                    timestamp: new Date('2025-06-19T16:15:00').getTime()
                }
            ];
            
            return sampleReservations;
        }
        
        function updateStats() {
            const total = allReservations.length;
            const tentative = allReservations.filter(r => r.status === 'tentative').length;
            const confirmed = allReservations.filter(r => r.status === 'confirmed').length;
            const canceled = allReservations.filter(r => r.status === 'canceled').length;
            
            document.getElementById('totalReservations').textContent = total;
            document.getElementById('tentativeReservations').textContent = tentative;
            document.getElementById('confirmedReservations').textContent = confirmed;
            document.getElementById('canceledReservations').textContent = canceled;
        }
        
        function applyFilters() {
            const activeFilter = document.querySelector('.filter-btn.active').getAttribute('data-filter');
            const searchTerm = searchInput.value.toLowerCase().trim();
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            
            filteredReservations = allReservations.filter(reservation => {
                // Status filter
                if (activeFilter === 'tentative' && reservation.status !== 'tentative') return false;
                if (activeFilter === 'confirmed' && reservation.status !== 'confirmed') return false;
                if (activeFilter === 'today') {
                    const today = new Date().toISOString().split('T')[0];
                    if (reservation.date !== today) return false;
                }
                if (activeFilter === 'thisweek') {
                    const today = new Date();
                    const weekStart = new Date(today.setDate(today.getDate() - today.getDay()));
                    const weekEnd = new Date(today.setDate(today.getDate() - today.getDay() + 6));
                    const reservationDate = new Date(reservation.date);
                    if (reservationDate < weekStart || reservationDate > weekEnd) return false;
                }
                
                // Search filter
                if (searchTerm) {
                    const searchableText = [
                        reservation.studentName,
                        reservation.className,
                        reservation.phone,
                        reservation.notes
                    ].join(' ').toLowerCase();
                    
                    if (!searchableText.includes(searchTerm)) return false;
                }
                
                // Date range filter
                if (startDate && reservation.date < startDate) return false;
                if (endDate && reservation.date > endDate) return false;
                
                return true;
            });
            
            renderReservations();
        }
        
        function renderReservations() {
            if (filteredReservations.length === 0) {
                reservationList.innerHTML = '';
                noReservationsState.style.display = 'block';
                return;
            }
            
            noReservationsState.style.display = 'none';
            
            // Sort by date and time
            filteredReservations.sort((a, b) => {
                if (a.date !== b.date) {
                    return new Date(a.date) - new Date(b.date);
                }
                return a.time.localeCompare(b.time);
            });
            
            const html = filteredReservations.map(reservation => createReservationCard(reservation)).join('');
            reservationList.innerHTML = html;
        }
        
        function createReservationCard(reservation) {
            const formattedDate = formatDate(reservation.date);
            const statusClass = `status-${reservation.status}`;
            const multipleReservationBadge = reservation.reservationCount > 1 ? 
                `<div class="multiple-reservation-badge">${reservation.reservationCount}</div>` : '';
            
            let actionButtons = '';
            if (reservation.status === 'tentative') {
                actionButtons = `
                    <button class="action-btn btn-confirm" onclick="updateReservationStatus('${reservation.id}', 'confirmed')">本予約に変更</button>
                    <button class="action-btn btn-cancel ml-2" onclick="updateReservationStatus('${reservation.id}', 'canceled')">キャンセル</button>
                `;
            } else if (reservation.status === 'confirmed') {
                actionButtons = `
                    <button class="action-btn btn-cancel" onclick="updateReservationStatus('${reservation.id}', 'canceled')">キャンセル</button>
                `;
            } else if (reservation.status === 'canceled') {
                actionButtons = `
                    <button class="action-btn btn-restore" onclick="updateReservationStatus('${reservation.id}', 'tentative')">仮予約に戻す</button>
                `;
            }
            
            return `
                <div class="card ${statusClass} p-4 pl-8">
                    <div class="status-bar"></div>
                    ${multipleReservationBadge}
                    <div class="flex flex-wrap">
                        <div class="info-cell w-1/6 pr-2 mb-3">
                            <div class="info-label">日時</div>
                            <div class="info-value">${formattedDate}<br>${reservation.time}</div>
                        </div>
                        <div class="info-cell w-1/6 pr-2 mb-3">
                            <div class="info-label">氏名</div>
                            <div class="info-value">${reservation.studentName}</div>
                        </div>
                        <div class="info-cell w-1/6 pr-2 mb-3">
                            <div class="info-label">クラス</div>
                            <div class="info-value">${reservation.className}</div>
                        </div>
                        <div class="info-cell w-1/6 pr-2 mb-3">
                            <div class="info-label">懇談形式</div>
                            <div class="info-value">${reservation.meetingType}</div>
                        </div>
                        <div class="info-cell w-1/6 pr-2 mb-3">
                            <div class="info-label">参加者</div>
                            <div class="info-value">${reservation.participants}</div>
                        </div>
                        <div class="info-cell w-1/6 pr-2 mb-3">
                            <div class="info-label">電話番号</div>
                            <div class="info-value">${reservation.phone}</div>
                        </div>
                        <div class="info-cell w-1/2 pr-2 mb-3">
                            <div class="info-label">備考</div>
                            <div class="info-value">${reservation.notes}</div>
                        </div>
                        <div class="info-cell w-1/4 pr-2 mb-3">
                            <div class="info-label">ステータス</div>
                            <div class="info-value">
                                <span class="status-label ${statusClass}">${getStatusLabel(reservation.status)}</span>
                            </div>
                        </div>
                        <div class="info-cell w-1/4 flex items-start justify-end space-x-2">
                            ${actionButtons}
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function updateReservationStatus(reservationId, newStatus) {
            try {
                // In a real implementation, this would call the Google Apps Script API
                // For now, we'll update the local data
                const reservation = allReservations.find(r => r.id === reservationId);
                if (reservation) {
                    reservation.status = newStatus;
                    updateStats();
                    applyFilters();
                    
                    // Show success message (optional)
                    console.log(`予約 ${reservationId} のステータスを ${newStatus} に更新しました`);
                }
                
                // Real API call would look like this:
                /*
                const response = await fetch(`${API_URL}?action=updateReservation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        id: reservationId,
                        status: newStatus
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    loadReservations(); // Reload data
                } else {
                    throw new Error(result.error || 'ステータス更新に失敗しました');
                }
                */
                
            } catch (error) {
                console.error('Error updating reservation status:', error);
                alert('ステータスの更新に失敗しました: ' + error.message);
            }
        }
        
        function getStatusLabel(status) {
            switch (status) {
                case 'tentative': return '仮予約';
                case 'confirmed': return '本予約';
                case 'canceled': return 'キャンセル';
                default: return status;
            }
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString);
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const dayOfWeek = ['日', '月', '火', '水', '木', '金', '土'][date.getDay()];
            return `${month}/${day}(${dayOfWeek})`;
        }
        
        function showLoading() {
            loadingState.style.display = 'flex';
            errorState.style.display = 'none';
            reservationList.style.display = 'none';
            noReservationsState.style.display = 'none';
        }
        
        function hideLoading() {
            loadingState.style.display = 'none';
            reservationList.style.display = 'block';
        }
        
        function showError(message) {
            loadingState.style.display = 'none';
            errorMessage.textContent = message;
            errorState.style.display = 'block';
            reservationList.style.display = 'none';
            noReservationsState.style.display = 'none';
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"95763474a9c3dfa1","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.6.2","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDt%2BEhcnHBCo8rGc991cl2WNrd%2FrUMtbW%2FuWPBihHL97SNNv67AIsaf1F7sGOoRnuxSqtYiOl%2BRWvCSDLv3JPjJE6qh%2B4Kx7%2BI6ATfIX9UB5%2BJ%2BNw7CCp7q%2BJCxgjAlkpk78zGUXJ71Yel6JSne0ZVRYTQACXeqJmWWy2Otl177KX9nbLwq%2B49ghgWFBnj%2FxkGzzEqIMLYFAwzULWgoyTYIEtX7hkAk5I8WDsYCSBI6ujiGTYsb%2BZWObZGFyf3zRToiGlCbVI9KXEY6KHQJVin4V5awXBoTGIbdtQ%2BfOyd7r4OemloBI62gvk9zgIooaN0cR8ILHGzdD6Z08drRdvmPwyK%2B8tU7ellDrMSxJHcdueuCXX%2BjzuJaBj44TVAGrIhAFyLgb4I5PxmAqhd10kMh4OmMEEPnQIxCD%2FTKE7vl%2Fb8Q6gXtT%2FXU6fqjFBiVhKEahDHQLvCI0uF2zJ62ay0dAs4TBnTkAIaN0rPSKutKkApe9JOmCtP9IQIw68rXAFFUzoMM7GOTpZvkPgA4E%2BJQY%3D";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDt+EhcnHBCo8rGc991cl2WNrd/rUMtbW/uWPBihHL97SNNv67AIsaf1F7sGOoRnuxSqtYiOl+RWvCSDLv3JPjJE6qh+4Kx7+I6ATfIX9UB5+J+Nw7CCp7q+JCxgjAlkpk78zGUXJ71Yel6JSne0ZVRYTQACXeqJmWWy2Otl177KX9nbLwq+49ghgWFBnj/xkGzzEqIMLYFAwzULWgoyTYIEtX7hkAk5I8WDsYCSBI6ujiGTYsb+ZWObZGFyf3zRToiGlCbVI9KXEY6KHQJVin4V5awXBoTGIbdtQ+fOyd7r4OemloBI62gvk9zgIooaN0cR8ILHGzdD6Z08drRdvmPwyK+8tU7ellDrMSxJHcdueuCXX+jzuJaBj44TVAGrIhAFyLgb4I5PxmAqhd10kMh4OmMEEPnQIxCD/TKE7vl/b8Q6gXtT/XU6fqjFBiVhKEahDHQLvCI0uF2zJ62ay0dAs4TBnTkAIaN0rPSKutKkApe9JOmCtP9IQIw68rXAFFUzoMM7GOTpZvkPgA4E+JQY=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    