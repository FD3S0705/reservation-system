<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>保護者懇談 予約システム - 京進の中学・高校受験TOPΣ河瀬校</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif;
            background: #f5f5f7;
            color: #1d1d1f;
        }
        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
            border: 1px solid rgba(0, 0, 0, 0.04);
        }
        .btn-primary {
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        .btn-primary:disabled {
            background: #8E8E93;
            cursor: not-allowed;
            transform: none;
        }
        .form-input {
            border: 1px solid #d1d1d6;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 16px;
            transition: border-color 0.2s ease;
        }
        .form-input:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 3px rgba(0, 122, 255, 0.1);
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px 0;
        }
        .checkbox-item input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.2);
        }
        .time-slot {
            background: white;
            border: 2px solid #e5e5e7;
            border-radius: 8px;
            padding: 12px 16px;
            margin: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        .time-slot:hover {
            border-color: #007AFF;
            background: #f0f8ff;
        }
        .time-slot.selected {
            border-color: #007AFF;
            background: #007AFF;
            color: white;
        }
        .time-slot.unavailable {
            background: #f5f5f5;
            color: #8e8e93;
            cursor: not-allowed;
            border-color: #e5e5e5;
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: #8e8e93;
        }
        .error {
            background: #ff3b30;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 16px 0;
        }
        .success {
            background: #34c759;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            margin: 16px 0;
        }
        .radio-group {
            display: flex;
            gap: 16px;
            flex-wrap: wrap;
        }
        .radio-item {
            display: flex;
            align-items: center;
        }
        .radio-item input[type="radio"] {
            margin-right: 8px;
            transform: scale(1.2);
        }
    </style>
</head>
<body class="bg-gray-50">
    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">保護者懇談 予約システム</h1>
            <p class="text-xl text-gray-600">京進の中学・高校受験TOPΣ河瀬校</p>
        </div>

        <!-- Loading State -->
        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin text-2xl mb-4"></i>
            <p class="text-lg">設定データを読み込んでいます...</p>
            <p class="text-sm">しばらくお待ちください</p>
        </div>

        <!-- Main Form -->
        <form id="reservationForm" class="hidden">
            <!-- Student Information -->
            <div class="card p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">お子様について</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">学年</label>
                        <select id="grade" class="form-input w-full" required>
                            <option value="">選択してください</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">クラス</label>
                        <select id="class" class="form-input w-full" required>
                            <option value="">まず学年を選択してください</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">姓</label>
                        <input type="text" id="lastName" class="form-input w-full" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">名</label>
                        <input type="text" id="firstName" class="form-input w-full" required>
                    </div>
                </div>
            </div>

            <!-- Conference Information -->
            <div class="card p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">保護者懇談について</h2>
                
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">懇談への参加</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="participate_yes" name="participate" value="希望する" required>
                            <label for="participate_yes">希望する</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="participate_no" name="participate" value="希望しない">
                            <label for="participate_no">希望しない</label>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">懇談の形式</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" id="format_face" name="format" value="対面" required>
                            <label for="format_face">対面</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" id="format_zoom" name="format" value="Zoom">
                            <label for="format_zoom">Zoom</label>
                        </div>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">参加者（複数選択可）</label>
                    <div class="flex flex-wrap gap-4">
                        <div class="checkbox-item">
                            <input type="checkbox" id="participant_father" name="participants" value="父">
                            <label for="participant_father">父</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="participant_mother" name="participants" value="母">
                            <label for="participant_mother">母</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="participant_student" name="participants" value="本人">
                            <label for="participant_student">本人</label>
                        </div>
                    </div>
                    <input type="text" id="participant_other" class="form-input w-full mt-2" placeholder="その他">
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">ご質問・ご要望など</label>
                    <textarea id="notes" class="form-input w-full" rows="3" placeholder="何かございましたらご記入ください"></textarea>
                </div>
            </div>

            <!-- Date/Time Selection -->
            <div class="card p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">日時選択</h2>
                <p class="text-gray-600 mb-4">ご参加が可能な日時をお選びください。可能な限り日時をご選択の上、日程調整にご協力いただきますと幸いです。</p>
                
                <div id="dateTimeContainer">
                    <div id="dateTimeLoading" class="text-center py-8">
                        <i class="fas fa-spinner fa-spin text-xl mb-2"></i>
                        <p>利用可能な日時を読み込んでいます...</p>
                    </div>
                </div>

                <div id="selectedTimes" class="mt-6 hidden">
                    <h3 class="text-lg font-medium mb-2">選択した日時（仮予約）</h3>
                    <div id="selectedTimesList" class="bg-blue-50 p-4 rounded-lg"></div>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="card p-6 mb-6">
                <h2 class="text-xl font-semibold mb-4">連絡先</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">電話番号</label>
                        <input type="tel" id="phone" class="form-input w-full" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">メールアドレス</label>
                        <input type="email" id="email" class="form-input w-full" required>
                        <p class="text-xs text-gray-500 mt-1">予約確定後、システムを通じてメール送付いたします。ご記入いただいたメールアドレスは予約確認にのみ使用し、保存・閲覧されることはございません。</p>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="text-center">
                <button type="submit" id="submitBtn" class="btn-primary text-lg px-8 py-3">
                    <i class="fas fa-paper-plane mr-2"></i>
                    この内容で提出する
                </button>
            </div>
        </form>

        <!-- Error/Success Messages -->
        <div id="messageContainer"></div>
    </div>

    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbxWMp5v5Nn_Qvr97gbIwOqcKDXB-oN4tXJX1T2YfHAu1r5QNF80Orw50WvD_gmUM3e0qg/exec';
        
        let systemSettings = null;
        let selectedTimeSlots = [];

        // Load system settings
        async function loadSettings() {
            try {
                const response = await fetch(API_URL, {
                    method: 'GET',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    systemSettings = data;
                    initializeForm();
                } else {
                    throw new Error('設定データの読み込みに失敗しました');
                }
            } catch (error) {
                console.error('Settings load error:', error);
                showError('設定データの読み込み中にエラーが発生しました。ページを再読み込みしてください。');
            }
        }

        // Initialize form with settings
        function initializeForm() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('reservationForm').classList.remove('hidden');
            
            populateGrades();
            generateTimeSlots();
        }

        // Populate grade dropdown
        function populateGrades() {
            const gradeSelect = document.getElementById('grade');
            gradeSelect.innerHTML = '<option value="">選択してください</option>';
            
            Object.keys(systemSettings.classes).forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                gradeSelect.appendChild(option);
            });
        }

        // Handle grade change
        document.getElementById('grade').addEventListener('change', function() {
            const classSelect = document.getElementById('class');
            const selectedGrade = this.value;
            
            classSelect.innerHTML = '<option value="">選択してください</option>';
            
            if (selectedGrade && systemSettings.classes[selectedGrade]) {
                systemSettings.classes[selectedGrade].forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    classSelect.appendChild(option);
                });
            }
        });

        // Generate time slots
        function generateTimeSlots() {
            const container = document.getElementById('dateTimeContainer');
            const loading = document.getElementById('dateTimeLoading');
            
            try {
                const startDate = new Date(systemSettings.settings.startDate);
                const endDate = new Date(systemSettings.settings.endDate);
                
                container.innerHTML = '';
                
                const currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    const dateStr = currentDate.toLocaleDateString('ja-JP');
                    const dayOfWeek = ['日曜日', '月曜日', '火曜日', '水曜日', '木曜日', '金曜日', '土曜日'][currentDate.getDay()];
                    
                    const schedule = getScheduleForDate(currentDate, dayOfWeek);
                    
                    if (schedule.isOpen && schedule.timeSlots.length > 0) {
                        const dayContainer = createDayContainer(dateStr, dayOfWeek, schedule.timeSlots);
                        container.appendChild(dayContainer);
                    }
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                }
            } catch (error) {
                console.error('Time slot generation error:', error);
                container.innerHTML = '<p class="text-red-500">日時スロットの生成中にエラーが発生しました。</p>';
            }
        }

        // Get schedule for specific date
        function getScheduleForDate(date, dayOfWeek) {
            const dateStr = formatDateForException(date);
            
            // Check exceptions first
            if (systemSettings.exceptions[dateStr]) {
                return systemSettings.exceptions[dateStr];
            }
            
            // Use weekday schedule
            return systemSettings.weekdaySchedule[dayOfWeek] || { isOpen: false, timeSlots: [] };
        }

        // Format date for exception lookup
        function formatDateForException(date) {
            const year = date.getFullYear();
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${year}/${month}/${day}`;
        }

        // Create day container
        function createDayContainer(dateStr, dayOfWeek, timeSlots) {
            const dayDiv = document.createElement('div');
            dayDiv.className = 'mb-6';
            
            const header = document.createElement('h3');
            header.className = 'text-lg font-medium mb-3';
            header.textContent = `${dateStr} (${dayOfWeek})`;
            dayDiv.appendChild(header);
            
            const slotsContainer = document.createElement('div');
            slotsContainer.className = 'grid grid-cols-2 md:grid-cols-4 gap-2';
            
            timeSlots.forEach(timeSlot => {
                const slotDiv = document.createElement('div');
                slotDiv.className = 'time-slot';
                slotDiv.textContent = timeSlot;
                slotDiv.dataset.date = dateStr;
                slotDiv.dataset.time = timeSlot;
                
                slotDiv.addEventListener('click', function() {
                    toggleTimeSlot(this);
                });
                
                slotsContainer.appendChild(slotDiv);
            });
            
            dayDiv.appendChild(slotsContainer);
            return dayDiv;
        }

        // Toggle time slot selection
        function toggleTimeSlot(element) {
            const date = element.dataset.date;
            const time = element.dataset.time;
            const slotId = `${date}_${time}`;
            
            if (element.classList.contains('selected')) {
                element.classList.remove('selected');
                selectedTimeSlots = selectedTimeSlots.filter(slot => slot.id !== slotId);
            } else {
                element.classList.add('selected');
                selectedTimeSlots.push({
                    id: slotId,
                    date: date,
                    time: time,
                    display: `${date} ${time}`
                });
            }
            
            updateSelectedTimesList();
        }

        // Update selected times list
        function updateSelectedTimesList() {
            const container = document.getElementById('selectedTimes');
            const list = document.getElementById('selectedTimesList');
            
            if (selectedTimeSlots.length > 0) {
                container.classList.remove('hidden');
                list.innerHTML = selectedTimeSlots.map(slot => 
                    `<div class="mb-1">${slot.display}</div>`
                ).join('');
            } else {
                container.classList.add('hidden');
            }
        }

        // Handle form submission
        document.getElementById('reservationForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (selectedTimeSlots.length === 0) {
                showError('希望日時を最低1つ選択してください。');
                return;
            }
            
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>送信中...';
            
            try {
                const formData = collectFormData();
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    showSuccess('予約を受け付けました。確認メールをお送りしますので、しばらくお待ちください。');
                    document.getElementById('reservationForm').reset();
                    selectedTimeSlots = [];
                    updateSelectedTimesList();
                } else {
                    throw new Error(result.message || '予約の送信に失敗しました');
                }
                
            } catch (error) {
                console.error('Submission error:', error);
                showError('予約の送信中にエラーが発生しました。時間をおいて再度お試しください。');
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane mr-2"></i>この内容で提出する';
            }
        });

        // Collect form data
        function collectFormData() {
            const participants = Array.from(document.querySelectorAll('input[name="participants"]:checked')).map(el => el.value);
            const otherParticipant = document.getElementById('participant_other').value.trim();
            if (otherParticipant) participants.push(otherParticipant);
            
            return {
                action: 'submitReservation',
                data: {
                    studentName: document.getElementById('lastName').value + ' ' + document.getElementById('firstName').value,
                    grade: document.getElementById('grade').value,
                    class: document.getElementById('class').value,
                    phone: document.getElementById('phone').value,
                    email: document.getElementById('email').value,
                    participate: document.querySelector('input[name="participate"]:checked')?.value,
                    format: document.querySelector('input[name="format"]:checked')?.value,
                    participants: participants.join(', '),
                    notes: document.getElementById('notes').value,
                    selectedTimes: selectedTimeSlots.map(slot => slot.display),
                    timestamp: new Date().toISOString()
                }
            };
        }

        // Show error message
        function showError(message) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="error"><i class="fas fa-exclamation-triangle mr-2"></i>${message}</div>`;
            container.scrollIntoView({ behavior: 'smooth' });
        }

        // Show success message
        function showSuccess(message) {
            const container = document.getElementById('messageContainer');
            container.innerHTML = `<div class="success"><i class="fas fa-check-circle mr-2"></i>${message}</div>`;
            container.scrollIntoView({ behavior: 'smooth' });
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadSettings();
        });
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"9582b075df028cfe","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.6.2","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDuulefh4NmlTOZwu4qZ4u9MYM5cZKcTsrSTy%2FutKI3K48QmBoLClIeK9ggPmwadg%2FHAK0i5J2ddg%2BdbE50eXgrb5jrkxt03oB4VNBb4il2Kq%2BTb8ZYUX1rjoWRe8R86HUlTzaZlxRHnpKCw3cz9v3XwcAYAqp3a5UysA%2FYyOeGAMZ9nc2%2ByzU%2FVPIeAB2fEOS4sGHBs6lwDhYIn1%2Fz9x8NCzFtzv2jarJ7PppqnB3riN1nWx0i87KLE%2BmV9JBAL7hdAuecsGvAYNnmRdH86qDmklF5J%2FS9jBrNDoV6QibHORpHHZDrmj%2BsO37dS%2BtXlbPMd0s68DMWhkm1aT3ACeMGomDrTQSL4MXtVJFypyhBpl%2F3HIwkXkHvhf8kM9BwzaKJXTMcArSFfTud%2BOosEUNcy0tl9uHmBxWx9FZljfdtxtfAfaKt7fWwhzx%2FlVP9AaXU4oi2MCG%2FZq4MtWrOk0TeHTM%2FEfwbG1prBsCMf4r%2B19rmRDnl7mV3sJglUwqC9YYihual9wREbr%2Fu7GrfbaOls%3D";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDuulefh4NmlTOZwu4qZ4u9MYM5cZKcTsrSTy/utKI3K48QmBoLClIeK9ggPmwadg/HAK0i5J2ddg+dbE50eXgrb5jrkxt03oB4VNBb4il2Kq+Tb8ZYUX1rjoWRe8R86HUlTzaZlxRHnpKCw3cz9v3XwcAYAqp3a5UysA/YyOeGAMZ9nc2+yzU/VPIeAB2fEOS4sGHBs6lwDhYIn1/z9x8NCzFtzv2jarJ7PppqnB3riN1nWx0i87KLE+mV9JBAL7hdAuecsGvAYNnmRdH86qDmklF5J/S9jBrNDoV6QibHORpHHZDrmj+sO37dS+tXlbPMd0s68DMWhkm1aT3ACeMGomDrTQSL4MXtVJFypyhBpl/3HIwkXkHvhf8kM9BwzaKJXTMcArSFfTud+OosEUNcy0tl9uHmBxWx9FZljfdtxtfAfaKt7fWwhzx/lVP9AaXU4oi2MCG/Zq4MtWrOk0TeHTM/EfwbG1prBsCMf4r+19rmRDnl7mV3sJglUwqC9YYihual9wREbr/u7GrfbaOls=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    