<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>保護者懇談予約システム | 京進の中学・高校受験TOPΣ河瀬校</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fontsource/sf-pro-display@4.5.0/index.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            color: #333;
            background-color: #fff;
        }
        .apple-blue {
            color: #007AFF;
        }
        .apple-blue-bg {
            background-color: #007AFF;
        }
        .date-circle {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 4px;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            min-width: 36px;
            max-width: 36px;
            min-height: 36px;
            max-height: 36px;
        }
        .date-circle.selected {
            background-color: transparent;
            color: #007AFF;
            border: 2px solid #007AFF;
        }
        .date-circle.disabled {
            color: #ccc;
            border-color: #eee;
            cursor: not-allowed;
        }
        .time-slot {
            border: 1px solid #e0e0e0;
            border-radius: 4px;
            padding: 8px 12px;
            margin: 4px 0;
            cursor: pointer;
        }
        .time-slot.selected {
            border-color: #007AFF;
            background-color: rgba(0, 122, 255, 0.1);
        }
        .calendar-scroll {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .calendar-scroll::-webkit-scrollbar {
            display: none;
        }
        .date-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 4px;
            flex: 0 0 auto;
        }
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #007AFF;
            box-shadow: 0 0 0 2px rgba(0, 122, 255, 0.2);
        }
        .apple-input {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            width: 100%;
            font-size: 16px;
        }
        .apple-btn {
            background-color: #007AFF;
            color: white;
            border-radius: 8px;
            padding: 12px 24px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .apple-btn:hover {
            background-color: #0069d9;
        }
        .apple-btn-secondary {
            background-color: #f2f2f2;
            color: #333;
        }
        .apple-btn-secondary:hover {
            background-color: #e0e0e0;
        }
        .required::after {
            content: "*";
            color: #FF3B30;
            margin-left: 4px;
        }
        .section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e0e0e0;
        }
        .hidden {
            display: none;
        }
        .weekday {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-bottom: 4px;
            width: 36px;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .sibling-entry {
            animation: fadeIn 0.3s ease-out;
        }
        
        .selected-dates-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 12px;
        }
        
        @media (min-width: 768px) {
            .selected-dates-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (min-width: 1024px) {
            .selected-dates-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
        
        .selected-date-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
        }
        
        .trash-icon {
            color: #FF3B30;
            margin-right: 8px;
            cursor: pointer;
        }

        .calendar-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-bottom: 16px;
        }

        .nav-btn {
            background: #f2f2f2;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .nav-btn:hover {
            background: #e0e0e0;
        }

        .nav-btn:disabled {
            background: #f8f8f8;
            color: #ccc;
            cursor: not-allowed;
        }

        .current-week {
            font-weight: 500;
            min-width: 200px;
            text-align: center;
        }

        .calendar-container {
            display: flex;
            justify-content: center;
            width: 100%;
            overflow-x: auto;
            padding: 0 16px;
        }

        .calendar-week {
            display: flex;
            gap: 8px;
            min-width: fit-content;
            justify-content: center;
            margin: 0 auto;
        }

        @media (max-width: 640px) {
            .calendar-container {
                padding: 0 8px;
            }
            
            .calendar-week {
                gap: 4px;
            }
            
            .date-circle {
                width: 32px;
                height: 32px;
                min-width: 32px;
                max-width: 32px;
                min-height: 32px;
                max-height: 32px;
                margin: 0 2px;
                font-size: 14px;
            }
            
            .weekday {
                width: 32px;
                font-size: 11px;
            }
            
            .date-item {
                margin: 0 2px;
            }
        }
    </style>
</head>
<body class="px-4 py-6 mx-auto" style="max-width: 800px;">
    <div id="loading" class="text-center py-10">
        <p class="text-xl font-medium">設定データを読み込んでいます...</p>
        <p class="mt-2 text-gray-600">しばらくお待ちください</p>
    </div>

    <div id="main-content" class="hidden">
        <header class="mb-8">
            <h1 id="system-title" class="text-2xl font-bold text-center mb-1">保護者懇談 予約システム</h1>
            <p id="school-name" class="text-center text-gray-600">京進の中学・高校受験TOPΣ河瀬校</p>
        </header>

        <form id="reservation-form" class="space-y-8">
            <!-- Student Information Section -->
            <section>
                <h2 class="section-title">お子様について</h2>
                <div id="students-container">
                    <div class="sibling-entry space-y-4 mb-4">
                        <!-- 学年・クラス選択（横並び） -->
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block mb-2 required">学年</label>
                                <select id="grade-select" class="apple-input" name="student_grade" required>
                                    <option value="" disabled selected>学年を選択してください</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-2 required">クラス</label>
                                <select id="class-select" class="apple-input" name="student_class" required disabled>
                                    <option value="" disabled selected>まず学年を選択してください</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block mb-2 required">姓</label>
                                <input type="text" class="apple-input" name="student_last_name" required>
                            </div>
                            <div>
                                <label class="block mb-2 required">名</label>
                                <input type="text" class="apple-input" name="student_first_name" required>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between items-center mt-4">
                    <button type="button" id="add-sibling" class="flex items-center text-sm apple-blue">
                        <span class="mr-2">＋</span>兄弟姉妹を追加
                    </button>
                    <button type="button" id="remove-sibling" class="flex items-center text-sm text-red-500 hidden">
                        <span class="mr-2">－</span>兄弟姉妹を削除
                    </button>
                </div>
            </section>

            <!-- Consultation Section -->
            <section>
                <h2 class="section-title">保護者懇談について</h2>
                <div class="mb-4">
                    <label class="block mb-2">懇談への参加</label>
                    <div class="flex space-x-4">
                        <label class="flex items-center">
                            <input type="radio" name="consultation" value="yes" class="mr-2">
                            希望する
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="consultation" value="no" class="mr-2">
                            希望しない
                        </label>
                    </div>
                </div>

                <!-- Additional fields for "希望する" -->
                <div id="consultation-details" class="space-y-4 hidden">
                    <div>
                        <label class="block mb-2">懇談の形式</label>
                        <div class="flex space-x-4">
                            <label class="flex items-center">
                                <input type="radio" name="format" value="in-person" class="mr-2">
                                対面
                            </label>
                            <label class="flex items-center">
                                <input type="radio" name="format" value="zoom" class="mr-2">
                                Zoom
                            </label>
                        </div>
                    </div>

                    <div>
                        <label class="block mb-2">参加者</label>
                        <div class="flex space-x-4 mb-2">
                            <label class="flex items-center">
                                <input type="checkbox" name="participants" value="father" class="mr-2">
                                父
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="participants" value="mother" class="mr-2">
                                母
                            </label>
                            <label class="flex items-center">
                                <input type="checkbox" name="participants" value="student" class="mr-2">
                                本人
                            </label>
                        </div>
                        <div>
                            <label class="block mb-2">その他</label>
                            <input type="text" name="other_participants" class="apple-input" placeholder="例：祖父、祖母、兄、姉など">
                        </div>
                    </div>

                    <div>
                        <label class="block mb-2">ご質問・ご要望など</label>
                        <textarea name="questions_requests" class="apple-input" rows="3"></textarea>
                    </div>

                    <!-- Date and Time Selection -->
                    <div class="mt-6">
                        <label class="block mb-2">日時選択</label>
                        <p class="text-sm text-gray-600 mb-4">ご参加が可能な日時をお選びください。可能な限り日時をご選択の上、日程調整にご協力いただきますと幸いです。</p>
                        
                        <!-- Calendar Navigation -->
                        <div class="calendar-navigation">
                            <button type="button" id="prev-week" class="nav-btn">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <div class="current-week" id="current-week-display">
                                <!-- 現在表示中の週を表示 -->
                            </div>
                            <button type="button" id="next-week" class="nav-btn">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        
                        <!-- Date Selection -->
                        <div class="calendar-container">
                            <div id="calendar" class="calendar-week">
                                <!-- カレンダーはJavaScriptで動的に生成 -->
                            </div>
                        </div>
                        
                        <!-- Time Selection -->
                        <div id="time-slots-container" class="mb-4 mt-4 hidden">
                            <p id="selected-date-display" class="text-sm text-gray-600 mb-2"></p>
                            <div id="time-slots" class="time-slots-container space-y-2">
                                <!-- 時間枠はJavaScriptで動的に生成 -->
                            </div>
                        </div>
                        
                        <!-- Selected Times -->
                        <div id="selected-times" class="mt-6 border-t pt-4 hidden">
                            <h3 class="font-medium mb-3">選択した日時（仮予約）</h3>
                            <div id="selected-dates-container" class="selected-dates-grid px-6 md:px-0">
                                <!-- 選択された日時はJavaScriptで動的に生成 -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Email Section -->
            <section id="email-section" class="hidden">
                <div class="mb-6">
                    <label class="block mb-2">メールアドレス</label>
                    <input type="email" name="email" class="apple-input" placeholder="例：example@email.com">
                    <p class="text-xs text-gray-500 mt-2">予約確定後、システムを通じてメール送付いたします。ご記入いただいたメールアドレスは予約確認にのみ使用し、保存・閲覧されることはございません。</p>
                </div>
            </section>

            <button type="submit" class="apple-btn w-full">この内容で提出する</button>
        </form>
    </div>

    <script>
        // Google Apps ScriptのウェブアプリURL
        const API_URL = 'https://script.google.com/macros/s/AKfycbwXh1EiALn1p24MRTCKKyx-A8fkY0Tb6SQrmhI7BZLxz22r8k6TfkK213Mpq9DXnR7UkA/exec';
        
        // 選択された日時を保存する配列
        let selectedTimes = [];
        
        // 現在選択中の日付
        let currentSelectedDate = null;
        
        // カレンダーの表示開始日
        let calendarStartDate = new Date();
        
        // 予約期間
        let reservationStartDate = null;
        let reservationEndDate = null;
        
        // データを保存する変数
        let systemData = {
            settings: {},
            schedule: {},
            exceptions: {},
            classes: {}
        };

        // 曜日名の配列
        const WEEKDAY_NAMES = ["日曜日", "月曜日", "火曜日", "水曜日", "木曜日", "金曜日", "土曜日"];
        
        // ページ読み込み時の処理
        document.addEventListener('DOMContentLoaded', async function() {
            try {
                console.log('初期化開始...');
                
                // スプレッドシートからデータを取得
                await loadSpreadsheetData();
                
                // システム情報を設定
                document.getElementById('system-title').textContent = systemData.settings.title || '保護者懇談 予約システム';
                document.getElementById('school-name').textContent = systemData.settings.schoolName || '京進の中学・高校受験TOPΣ河瀬校';
                
                // 予約期間を設定
                setupReservationPeriod();
                
                // 学年選択肢を初期化
                initializeGradeOptions();
                
                // カレンダーを初期化
                initCalendar();
                
                // イベントリスナーを設定
                setupEventListeners();
                
                // ローディング表示を非表示にしてメインコンテンツを表示
                document.getElementById('loading').classList.add('hidden');
                document.getElementById('main-content').classList.remove('hidden');
                
                console.log('初期化完了');
                
            } catch (error) {
                console.error('初期化エラー:', error);
                // エラー時はローカルデータで初期化
                initializeWithLocalData();
            }
        });

        // 予約期間を設定する関数
        function setupReservationPeriod() {
            if (systemData.settings.startDate && systemData.settings.endDate) {
                reservationStartDate = new Date(systemData.settings.startDate);
                reservationEndDate = new Date(systemData.settings.endDate);
                
                // 現在の日付が予約期間より前の場合は開始日に設定
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (today < reservationStartDate) {
                    calendarStartDate = new Date(reservationStartDate);
                } else if (today > reservationEndDate) {
                    calendarStartDate = new Date(reservationEndDate);
                } else {
                    calendarStartDate = new Date(today);
                }
            }
        }

        // スプレッドシートからデータを取得する関数
        async function loadSpreadsheetData() {
            try {
                console.log('スプレッドシートからデータを取得中...');
                
                if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
                    throw new Error('Google Apps ScriptのURLが設定されていません');
                }
                
                const response = await fetch(API_URL);
                
                if (!response.ok) {
                    throw new Error(`API エラー: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                console.log('取得したデータ:', data);
                
                if (!data.success) {
                    throw new Error(data.error || 'APIからエラーが返されました');
                }
                
                // データを保存
                systemData.settings = data.settings || {};
                systemData.schedule = data.weekdaySchedule || {};
                systemData.exceptions = data.exceptions || {};
                systemData.classes = data.classes || {};
                
                console.log('スプレッドシートデータの取得完了');
                
            } catch (error) {
                console.error('スプレッドシートデータ取得エラー:', error);
                throw error;
            }
        }

        // ローカルデータで初期化する関数（エラー時のフォールバック）
        function initializeWithLocalData() {
            console.log('ローカルデータで初期化中...');
            
            // 基本設定
            systemData.settings = {
                title: '保護者懇談 予約システム',
                schoolName: '京進の中学・高校受験TOPΣ河瀬校',
                startDate: '2025/04/14',
                endDate: '2025/06/30'
            };
            
            // スケジュールデータ
            systemData.schedule = {
                '月曜日': { isOpen: true, timeSlots: ['14:00-14:40', '15:00-15:40', '16:00-16:40', '21:30-22:10'] },
                '火曜日': { isOpen: true, timeSlots: ['14:00-14:40', '15:00-15:40', '16:00-16:40', '17:00-17:40', '19:30-20:10', '21:30-22:10'] },
                '水曜日': { isOpen: true, timeSlots: ['14:00-14:40', '15:00-15:40', '16:00-16:40', '21:30-22:10'] },
                '木曜日': { isOpen: false, timeSlots: [] },
                '金曜日': { isOpen: true, timeSlots: ['14:00-14:40', '15:00-15:40', '16:00-16:40', '20:30-21:10', '21:30-22:10'] },
                '土曜日': { isOpen: true, timeSlots: ['14:00-14:40', '15:00-15:40', '16:00-16:40', '21:30-22:10'] },
                '日曜日': { isOpen: false, timeSlots: [] }
            };
            
            // 例外日
            systemData.exceptions = {
                '2025/04/30': { isOpen: false, timeSlots: [] },
                '2025/05/02': { isOpen: false, timeSlots: [] },
                '2025/05/03': { isOpen: false, timeSlots: [] },
                '2025/05/05': { isOpen: false, timeSlots: [] },
                '2025/05/06': { isOpen: false, timeSlots: [] },
                '2025/05/28': { isOpen: false, timeSlots: [] },
                '2025/06/01': { isOpen: true, timeSlots: ['13:00-13:40', '14:00-14:40'] }
            };
            
            // クラスデータ
            systemData.classes = {
                '小1': ['Kid\'sゼミ', 'パズル道場'],
                '小2': ['Kid\'sゼミ', 'パズル道場'],
                '小3': ['Kid\'sゼミ', 'パズル道場'],
                '小4': ['4H', 'Kid\'sゼミ', 'パズル道場'],
                '小5': ['5H', '小5県中', 'パズル道場'],
                '小6': ['6H', '小6県中', 'パズル道場'],
                '中1': ['1H', '1A', '1K'],
                '中2': ['2H', '2A', '2K'],
                '中3': ['3H', '3A', '3K']
            };
            
            // システム情報を設定
            document.getElementById('system-title').textContent = systemData.settings.title;
            document.getElementById('school-name').textContent = systemData.settings.schoolName;
            
            // 予約期間を設定
            setupReservationPeriod();
            
            // 学年選択肢を初期化
            initializeGradeOptions();
            
            // カレンダーを初期化
            initCalendar();
            
            // イベントリスナーを設定
            setupEventListeners();
            
            // ローディング表示を非表示にしてメインコンテンツを表示
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            
            console.log('ローカルデータでの初期化完了');
        }

        // 学年選択肢を初期化する関数
        function initializeGradeOptions() {
            const gradeSelect = document.getElementById('grade-select');
            const grades = Object.keys(systemData.classes);
            
            // 既存のオプションをクリア（最初のプレースホルダーを除く）
            gradeSelect.innerHTML = '<option value="" disabled selected>学年を選択してください</option>';
            
            grades.forEach(grade => {
                const option = document.createElement('option');
                option.value = grade;
                option.textContent = grade;
                gradeSelect.appendChild(option);
            });
        }

        // 学年変更時にクラス選択肢を更新する関数
        function updateClassOptions(selectedGrade) {
            const classSelect = document.getElementById('class-select');
            classSelect.innerHTML = '<option value="" disabled selected>クラスを選択してください</option>';
            
            if (selectedGrade && systemData.classes[selectedGrade]) {
                systemData.classes[selectedGrade].forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    classSelect.appendChild(option);
                });
                classSelect.disabled = false;
            } else {
                classSelect.innerHTML = '<option value="" disabled selected>まず学年を選択してください</option>';
                classSelect.disabled = true;
            }
        }
        
        // カレンダー初期化関数
        function initCalendar() {
            const calendarContainer = document.getElementById('calendar');
            calendarContainer.innerHTML = '';
            
            // その週に予約可能な日があるかチェック
            const startOfWeek = getStartOfWeek(calendarStartDate);
            const hasReservableDay = hasReservableDayInWeek(startOfWeek);
            
            if (!hasReservableDay) {
                // 予約可能な日がない場合は次の週を探す
                findNextReservableWeek();
                return;
            }
            
            // 1週間分の日付を表示（予約期間内のみ）
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(date.getDate() + i);
                
                // 予約期間内の日付のみ表示
                if (isWithinReservationPeriod(date)) {
                    const dateItem = createDateItem(date);
                    calendarContainer.appendChild(dateItem);
                }
            }
            
            updateWeekDisplay();
            updateNavigationButtons();
        }

        // その週に予約可能な日があるかチェックする関数
        function hasReservableDayInWeek(startOfWeek) {
            for (let i = 0; i < 7; i++) {
                const date = new Date(startOfWeek);
                date.setDate(date.getDate() + i);
                
                if (isWithinReservationPeriod(date) && isSchoolOpen(date)) {
                    return true;
                }
            }
            return false;
        }

        // 次の予約可能な週を見つける関数
        function findNextReservableWeek() {
            let testDate = new Date(calendarStartDate);
            let attempts = 0;
            const maxAttempts = 20; // 無限ループ防止
            
            while (attempts < maxAttempts) {
                const startOfWeek = getStartOfWeek(testDate);
                
                if (hasReservableDayInWeek(startOfWeek)) {
                    calendarStartDate = new Date(testDate);
                    initCalendar();
                    return;
                }
                
                testDate.setDate(testDate.getDate() + 7);
                attempts++;
                
                // 予約期間を超えた場合は終了
                if (reservationEndDate && testDate > reservationEndDate) {
                    break;
                }
            }
            
            // 予約可能な週が見つからない場合
            const calendarContainer = document.getElementById('calendar');
            calendarContainer.innerHTML = '<p class="text-center text-gray-500 py-4">予約可能な日程がありません</p>';
            updateWeekDisplay();
            updateNavigationButtons();
        }

        // 週の開始日を取得する関数（月曜日始まり）
        function getStartOfWeek(date) {
            const startOfWeek = new Date(date);
            const day = startOfWeek.getDay();
            const diff = startOfWeek.getDate() - day + (day === 0 ? -6 : 1); // 月曜日を開始日に
            startOfWeek.setDate(diff);
            return startOfWeek;
        }

        // 週表示を更新する関数
        function updateWeekDisplay() {
            const startOfWeek = getStartOfWeek(calendarStartDate);
            const endOfWeek = new Date(startOfWeek);
            endOfWeek.setDate(endOfWeek.getDate() + 6);
            
            const startStr = startOfWeek.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
            const endStr = endOfWeek.toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' });
            
            document.getElementById('current-week-display').textContent = `${startStr} 〜 ${endStr}`;
        }

        // ナビゲーションボタンの状態を更新する関数
        function updateNavigationButtons() {
            const prevBtn = document.getElementById('prev-week');
            const nextBtn = document.getElementById('next-week');
            
            if (!reservationStartDate || !reservationEndDate) {
                prevBtn.disabled = true;
                nextBtn.disabled = true;
                return;
            }
            
            // 前週に予約可能な日があるかチェック
            const prevWeekStart = new Date(calendarStartDate);
            prevWeekStart.setDate(prevWeekStart.getDate() - 7);
            const hasPrevReservableWeek = findReservableWeekBefore(calendarStartDate);
            
            // 次週に予約可能な日があるかチェック
            const nextWeekStart = new Date(calendarStartDate);
            nextWeekStart.setDate(nextWeekStart.getDate() + 7);
            const hasNextReservableWeek = findReservableWeekAfter(calendarStartDate);
            
            prevBtn.disabled = !hasPrevReservableWeek;
            nextBtn.disabled = !hasNextReservableWeek;
        }

        // 指定日より前で予約可能な週があるかチェック
        function findReservableWeekBefore(currentDate) {
            let testDate = new Date(currentDate);
            testDate.setDate(testDate.getDate() - 7);
            
            for (let i = 0; i < 10; i++) { // 最大10週前まで確認
                if (testDate < reservationStartDate) break;
                
                const startOfWeek = getStartOfWeek(testDate);
                if (hasReservableDayInWeek(startOfWeek)) {
                    return true;
                }
                
                testDate.setDate(testDate.getDate() - 7);
            }
            return false;
        }

        // 指定日より後で予約可能な週があるかチェック
        function findReservableWeekAfter(currentDate) {
            let testDate = new Date(currentDate);
            testDate.setDate(testDate.getDate() + 7);
            
            for (let i = 0; i < 10; i++) { // 最大10週後まで確認
                if (testDate > reservationEndDate) break;
                
                const startOfWeek = getStartOfWeek(testDate);
                if (hasReservableDayInWeek(startOfWeek)) {
                    return true;
                }
                
                testDate.setDate(testDate.getDate() + 7);
            }
            return false;
        }

        // 予約期間内かチェックする関数
        function isWithinReservationPeriod(date) {
            if (!reservationStartDate || !reservationEndDate) {
                return true; // 期間が設定されていない場合は制限なし
            }
            
            const checkDate = new Date(date);
            checkDate.setHours(0, 0, 0, 0);
            
            const startDate = new Date(reservationStartDate);
            startDate.setHours(0, 0, 0, 0);
            
            const endDate = new Date(reservationEndDate);
            endDate.setHours(0, 0, 0, 0);
            
            return checkDate >= startDate && checkDate <= endDate;
        }
        
        // 日付アイテムを作成する関数
        function createDateItem(date) {
            const dateItem = document.createElement('div');
            dateItem.className = 'date-item';
            
            const weekdayNames = ['日', '月', '火', '水', '木', '金', '土'];
            const weekdayIndex = date.getDay();
            const weekdayName = weekdayNames[weekdayIndex];
            
            const weekdayDiv = document.createElement('div');
            weekdayDiv.className = 'weekday';
            weekdayDiv.textContent = weekdayName;
            
            const dateCircle = document.createElement('div');
            dateCircle.className = 'date-circle';
            dateCircle.textContent = date.getDate();
            
            // 日付のデータ属性を設定
            const dateStr = formatDateForAPI(date);
            dateCircle.dataset.date = dateStr;
            
            // 予約期間内かつ開校日のチェック
            const isSelectable = isWithinReservationPeriod(date) && isSchoolOpen(date);
            
            if (!isSelectable) {
                dateCircle.classList.add('disabled');
            } else {
                // クリックイベント（選択可能日のみ）
                dateCircle.addEventListener('click', function() {
                    // 前に選択されていた日付の選択を解除
                    const previousSelected = document.querySelector('.date-circle.selected');
                    if (previousSelected) {
                        previousSelected.classList.remove('selected');
                    }
                    
                    // この日付を選択状態にする
                    this.classList.add('selected');
                    
                    // 選択された日付を保存
                    currentSelectedDate = dateStr;
                    
                    // 時間枠を表示
                    showTimeSlots(date);
                });
            }
            
            dateItem.appendChild(weekdayDiv);
            dateItem.appendChild(dateCircle);
            
            return dateItem;
        }
        
        // 学校が開校しているかどうかを判断する関数
        function isSchoolOpen(date) {
            const dateStr = formatDateForAPI(date);
            const weekdayName = WEEKDAY_NAMES[date.getDay()];
            
            // 例外日のチェック
            if (systemData.exceptions && systemData.exceptions[dateStr]) {
                return systemData.exceptions[dateStr].isOpen;
            }
            
            // 曜日の通常スケジュールをチェック
            if (systemData.schedule && systemData.schedule[weekdayName]) {
                return systemData.schedule[weekdayName].isOpen;
            }
            
            return false;
        }
        
        // 時間枠を表示する関数
        function showTimeSlots(date) {
            const timeSlotsContainer = document.getElementById('time-slots-container');
            const timeSlotsDiv = document.getElementById('time-slots');
            const selectedDateDisplay = document.getElementById('selected-date-display');
            
            // 日付表示を更新
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            selectedDateDisplay.textContent = date.toLocaleDateString('ja-JP', options) + 'の時間帯';
            
            // 時間枠をクリア
            timeSlotsDiv.innerHTML = '';
            
            // 時間枠を取得
            const timeSlots = getTimeSlotsForDate(date);
            
            if (timeSlots && timeSlots.length > 0) {
                // 「すべて」オプション
                const allSlot = document.createElement('div');
                allSlot.className = 'time-slot';
                allSlot.textContent = 'すべて';
                allSlot.addEventListener('click', function() {
                    const allSelected = this.classList.contains('selected');
                    document.querySelectorAll('.time-slot:not(:first-child)').forEach(slot => {
                        if (allSelected) {
                            slot.classList.remove('selected');
                            // 選択された時間帯を削除
                            const timeStr = slot.dataset.time;
                            const dateStr = formatDateForAPI(date);
                            removeSelectedTime(dateStr, timeStr);
                        } else {
                            slot.classList.add('selected');
                            // 選択された時間帯を追加
                            const timeStr = slot.dataset.time;
                            const dateStr = formatDateForAPI(date);
                            addSelectedTime(dateStr, timeStr);
                        }
                    });
                    this.classList.toggle('selected');
                    updateSelectedTimesList();
                });
                timeSlotsDiv.appendChild(allSlot);
                
                // 個別の時間枠
                timeSlots.forEach(timeSlot => {
                    const slot = document.createElement('div');
                    slot.className = 'time-slot';
                    slot.textContent = timeSlot;
                    slot.dataset.time = timeSlot;
                    
                    // 既に選択済みかチェック
                    const dateStr = formatDateForAPI(date);
                    if (isTimeSelected(dateStr, timeSlot)) {
                        slot.classList.add('selected');
                    }
                    
                    slot.addEventListener('click', function() {
                        this.classList.toggle('selected');
                        
                        // 選択状態を管理
                        const timeStr = this.dataset.time;
                        const dateStr = formatDateForAPI(date);
                        
                        if (this.classList.contains('selected')) {
                            addSelectedTime(dateStr, timeStr);
                        } else {
                            removeSelectedTime(dateStr, timeStr);
                        }
                        
                        // 全て選択されているかチェック
                        const allTimeSlots = document.querySelectorAll('.time-slot:not(:first-child)');
                        const allSelected = Array.from(allTimeSlots).every(s => s.classList.contains('selected'));
                        document.querySelector('.time-slot:first-child').classList.toggle('selected', allSelected);
                        
                        // 選択された日時リストを更新
                        updateSelectedTimesList();
                    });
                    
                    timeSlotsDiv.appendChild(slot);
                });
                
                // 時間枠コンテナを表示
                timeSlotsContainer.classList.remove('hidden');
                
                // 選択された日時リストを更新
                updateSelectedTimesList();
            } else {
                timeSlotsContainer.classList.add('hidden');
            }
        }
        
        // 指定された日付の時間枠を取得する関数
        function getTimeSlotsForDate(date) {
            const dateStr = formatDateForAPI(date);
            const weekdayName = WEEKDAY_NAMES[date.getDay()];
            
            // 例外日のチェック
            if (systemData.exceptions && systemData.exceptions[dateStr]) {
                return systemData.exceptions[dateStr].timeSlots || [];
            }
            
            // 曜日の通常スケジュールをチェック
            if (systemData.schedule && systemData.schedule[weekdayName]) {
                return systemData.schedule[weekdayName].timeSlots || [];
            }
            
            return [];
        }
        
        // 選択された時間を追加する関数
        function addSelectedTime(dateStr, timeStr) {
            const timeKey = `${dateStr} ${timeStr}`;
            if (!selectedTimes.some(item => item.key === timeKey)) {
                selectedTimes.push({
                    key: timeKey,
                    date: dateStr,
                    time: timeStr
                });
            }
        }
        
        // 選択された時間を削除する関数
        function removeSelectedTime(dateStr, timeStr) {
            const timeKey = `${dateStr} ${timeStr}`;
            selectedTimes = selectedTimes.filter(item => item.key !== timeKey);
        }
        
        // 時間が選択されているかチェックする関数
        function isTimeSelected(dateStr, timeStr) {
            const timeKey = `${dateStr} ${timeStr}`;
            return selectedTimes.some(item => item.key === timeKey);
        }
        
        // 選択された日時リストを更新する関数
        function updateSelectedTimesList() {
            const selectedTimesContainer = document.getElementById('selected-times');
            const selectedDatesContainer = document.getElementById('selected-dates-container');
            
            if (selectedTimes.length > 0) {
                // コンテナを表示
                selectedTimesContainer.classList.remove('hidden');
                
                // 日時をグループ化
                const groupedTimes = {};
                selectedTimes.forEach(item => {
                    if (!groupedTimes[item.date]) {
                        groupedTimes[item.date] = [];
                    }
                    groupedTimes[item.date].push(item);
                });
                
                // 日時カードを生成
                selectedDatesContainer.innerHTML = '';
                
                Object.keys(groupedTimes).forEach(date => {
                    const times = groupedTimes[date];
                    const card = document.createElement('div');
                    card.className = 'selected-date-card';
                    
                    // 日付表示
                    const dateParts = date.split('/');
                    const displayDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);
                    const options = { month: 'numeric', day: 'numeric', weekday: 'short' };
                    
                    const dateHeader = document.createElement('div');
                    dateHeader.className = 'font-medium mb-2';
                    dateHeader.textContent = displayDate.toLocaleDateString('ja-JP', options);
                    card.appendChild(dateHeader);
                    
                    // 時間枠表示
                    times.forEach(item => {
                        const timeContainer = document.createElement('div');
                        timeContainer.className = 'flex items-center mb-1';
                        
                        const trashIcon = document.createElement('span');
                        trashIcon.className = 'trash-icon';
                        trashIcon.innerHTML = '<i class="fas fa-trash-alt"></i>';
                        trashIcon.addEventListener('click', function() {
                            removeSelectedTime(item.date, item.time);
                            updateSelectedTimesList();
                            
                            // 現在表示中の日付と同じなら、その時間枠の選択も解除
                            if (currentSelectedDate === item.date) {
                                const timeSlot = document.querySelector(`.time-slot[data-time="${item.time}"]`);
                                if (timeSlot) {
                                    timeSlot.classList.remove('selected');
                                }
                                // すべて選択ボタンの状態も更新
                                const allSlot = document.querySelector('.time-slot:first-child');
                                if (allSlot) {
                                    const allTimeSlots = document.querySelectorAll('.time-slot:not(:first-child)');
                                    const allSelected = Array.from(allTimeSlots).every(s => s.classList.contains('selected'));
                                    allSlot.classList.toggle('selected', allSelected);
                                }
                            }
                        });
                        
                        const timeText = document.createElement('span');
                        timeText.textContent = item.time;
                        
                        timeContainer.appendChild(trashIcon);
                        timeContainer.appendChild(timeText);
                        card.appendChild(timeContainer);
                    });
                    
                    selectedDatesContainer.appendChild(card);
                });
                
            } else {
                // 選択がない場合は非表示
                selectedTimesContainer.classList.add('hidden');
            }
            
            // フォームに選択した日時を保存
            const hiddenInput = document.getElementById('selected-times-input') || document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.id = 'selected-times-input';
            hiddenInput.name = 'selected_times';
            hiddenInput.value = JSON.stringify(selectedTimes);
            
            if (!document.getElementById('selected-times-input')) {
                document.getElementById('reservation-form').appendChild(hiddenInput);
            }
        }
        
        // イベントリスナーを設定する関数
        function setupEventListeners() {
            // 学年変更時のクラス更新
            document.getElementById('grade-select').addEventListener('change', function() {
                updateClassOptions(this.value);
            });
            
            // 前の週へ移動するボタン
            document.getElementById('prev-week').addEventListener('click', function() {
                if (this.disabled) return;
                
                // 前の予約可能な週を探す
                let testDate = new Date(calendarStartDate);
                testDate.setDate(testDate.getDate() - 7);
                
                for (let i = 0; i < 10; i++) {
                    if (testDate < reservationStartDate) break;
                    
                    const startOfWeek = getStartOfWeek(testDate);
                    if (hasReservableDayInWeek(startOfWeek)) {
                        calendarStartDate = new Date(testDate);
                        initCalendar();
                        return;
                    }
                    
                    testDate.setDate(testDate.getDate() - 7);
                }
            });
            
            // 次の週へ移動するボタン
            document.getElementById('next-week').addEventListener('click', function() {
                if (this.disabled) return;
                
                // 次の予約可能な週を探す
                let testDate = new Date(calendarStartDate);
                testDate.setDate(testDate.getDate() + 7);
                
                for (let i = 0; i < 10; i++) {
                    if (testDate > reservationEndDate) break;
                    
                    const startOfWeek = getStartOfWeek(testDate);
                    if (hasReservableDayInWeek(startOfWeek)) {
                        calendarStartDate = new Date(testDate);
                        initCalendar();
                        return;
                    }
                    
                    testDate.setDate(testDate.getDate() + 7);
                }
            });
            
            // 懇談への参加の選択肢
            document.querySelectorAll('input[name="consultation"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const details = document.getElementById('consultation-details');
                    const emailSection = document.getElementById('email-section');
                    
                    if (this.value === 'yes') {
                        details.classList.remove('hidden');
                        emailSection.classList.remove('hidden');
                    } else {
                        details.classList.add('hidden');
                        emailSection.classList.add('hidden');
                    }
                });
            });
            
            // 兄弟姉妹を追加ボタン
            document.getElementById('add-sibling').addEventListener('click', function() {
                const container = document.getElementById('students-container');
                const siblingTemplate = document.querySelector('.sibling-entry').cloneNode(true);
                
                // 入力値をクリア
                siblingTemplate.querySelectorAll('input, select').forEach(input => {
                    input.value = '';
                    if (input.tagName === 'SELECT') {
                        input.selectedIndex = 0;
                    }
                });
                
                // 新しい兄弟姉妹の学年選択にイベントリスナーを追加
                const newGradeSelect = siblingTemplate.querySelector('select[name="student_grade"]');
                if (newGradeSelect) {
                    // 学年選択肢を設定
                    newGradeSelect.innerHTML = '<option value="" disabled selected>学年を選択してください</option>';
                    Object.keys(systemData.classes).forEach(grade => {
                        const option = document.createElement('option');
                        option.value = grade;
                        option.textContent = grade;
                        newGradeSelect.appendChild(option);
                    });
                    
                    newGradeSelect.addEventListener('change', function() {
                        const classSelect = this.parentElement.parentElement.querySelector('select[name="student_class"]');
                        updateClassOptionsForElement(classSelect, this.value);
                    });
                }
                
                container.appendChild(siblingTemplate);
                
                // 削除ボタンを表示
                document.getElementById('remove-sibling').classList.remove('hidden');
            });
            
            // 兄弟姉妹を削除ボタン
            document.getElementById('remove-sibling').addEventListener('click', function() {
                const container = document.getElementById('students-container');
                const siblings = container.querySelectorAll('.sibling-entry');
                
                if (siblings.length > 1) {
                    container.removeChild(siblings[siblings.length - 1]);
                    
                    // 最後の兄弟姉妹を削除したら、削除ボタンを非表示
                    if (siblings.length <= 2) {
                        this.classList.add('hidden');
                    }
                }
            });
            
            // フォーム送信
            document.getElementById('reservation-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // 基本的なバリデーション
                const participationRadio = document.querySelector('input[name="consultation"]:checked');
                if (!participationRadio) {
                    alert('懇談への参加希望を選択してください。');
                    return;
                }
                
                if (participationRadio.value === 'yes') {
                    const formatRadio = document.querySelector('input[name="format"]:checked');
                    if (!formatRadio) {
                        alert('懇談の形式を選択してください。');
                        return;
                    }
                    
                    const participants = document.querySelectorAll('input[name="participants"]:checked');
                    if (participants.length === 0) {
                        alert('参加者を少なくとも1人選択してください。');
                        return;
                    }
                    
                    if (selectedTimes.length === 0) {
                        alert('希望する日時を少なくとも1つ選択してください。');
                        return;
                    }
                    
                    const email = document.querySelector('input[name="email"]').value;
                    if (!email) {
                        alert('メールアドレスを入力してください。');
                        return;
                    }
                }
                
                // フォームデータの収集
                const formData = new FormData(this);
                const jsonData = {};
                
                formData.forEach((value, key) => {
                    if (jsonData[key]) {
                        // 既存のキーがある場合は配列にする
                        if (Array.isArray(jsonData[key])) {
                            jsonData[key].push(value);
                        } else {
                            jsonData[key] = [jsonData[key], value];
                        }
                    } else {
                        jsonData[key] = value;
                    }
                });
                
                // 参加者のチェックボックス値を配列として取得
                const participantsArray = [];
                document.querySelectorAll('input[name="participants"]:checked').forEach(checkbox => {
                    participantsArray.push(checkbox.value);
                });
                jsonData.participants = participantsArray;
                
                // 選択した日時を追加
                jsonData.selectedTimes = selectedTimes;
                
                // スプレッドシートに送信
                submitReservation(jsonData);
            });
        }

        // 予約データをスプレッドシートに送信する関数
        async function submitReservation(data) {
            try {
                console.log('予約データを送信中...', data);
                
                if (API_URL === 'YOUR_GOOGLE_APPS_SCRIPT_URL') {
                    // ローカルモードの場合
                    console.log('ローカルモード: 送信データ', data);
                    alert('予約が受け付けられました。\n（ローカルモード: 実際のデータは送信されていません）');
                    resetForm();
                    return;
                }
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });
                
                if (!response.ok) {
                    throw new Error(`送信エラー: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('送信結果:', result);
                
                if (result.success) {
                    alert('予約が正常に受け付けられました。\n予約ID: ' + (result.reservationId || '取得中'));
                    resetForm();
                } else {
                    throw new Error(result.error || '予約の保存に失敗しました');
                }
                
            } catch (error) {
                console.error('予約送信エラー:', error);
                alert('予約の送信中にエラーが発生しました。\n' + error.message + '\n\n時間をおいて再度お試しください。');
            }
        }

        // フォームをリセットする関数
        function resetForm() {
            document.getElementById('reservation-form').reset();
            selectedTimes = [];
            
            // 非表示セクションを隠す
            document.getElementById('consultation-details').classList.add('hidden');
            document.getElementById('email-section').classList.add('hidden');
            document.getElementById('selected-times').classList.add('hidden');
            document.getElementById('time-slots-container').classList.add('hidden');
            
            // 兄弟姉妹の入力欄をリセット
            const container = document.getElementById('students-container');
            const siblings = container.querySelectorAll('.sibling-entry');
            
            // 最初の1つ以外を削除
            for (let i = siblings.length - 1; i > 0; i--) {
                container.removeChild(siblings[i]);
            }
            
            // 削除ボタンを非表示
            document.getElementById('remove-sibling').classList.add('hidden');

            // クラス選択をリセット
            document.getElementById('class-select').innerHTML = '<option value="" disabled selected>まず学年を選択してください</option>';
            document.getElementById('class-select').disabled = true;
            
            // 日付選択をクリア
            const selectedDate = document.querySelector('.date-circle.selected');
            if (selectedDate) {
                selectedDate.classList.remove('selected');
            }
            currentSelectedDate = null;
        }

        // 特定の要素のクラス選択肢を更新する関数（兄弟姉妹追加時用）
        function updateClassOptionsForElement(classSelect, selectedGrade) {
            classSelect.innerHTML = '<option value="" disabled selected>クラスを選択してください</option>';
            
            if (selectedGrade && systemData.classes[selectedGrade]) {
                systemData.classes[selectedGrade].forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    classSelect.appendChild(option);
                });
                classSelect.disabled = false;
            } else {
                classSelect.innerHTML = '<option value="" disabled selected>まず学年を選択してください</option>';
                classSelect.disabled = true;
            }
        }
        
        // YYYY/MM/DD形式で日付を返す関数
        function formatDateForAPI(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}/${month}/${day}`;
        }
    </script>
<script defer src="https://static.cloudflareinsights.com/beacon.min.js/vcd15cbe7772f49c399c6a5babf22c1241717689176015" integrity="sha512-ZpsOmlRQV6y907TI0dKBHq9Md29nnaEIPlkf84rnaERnq6zvWvPUqr2ft8M1aS28oN72PdrCzSjY4U6VaAw1EQ==" data-cf-beacon='{"rayId":"95880f07fa1819e2","serverTiming":{"name":{"cfExtPri":true,"cfEdge":true,"cfOrigin":true,"cfL4":true,"cfSpeedBrain":true,"cfCacheStatus":true}},"version":"2025.6.2","token":"4edd5f8ec12a48cfa682ab8261b80a79"}' crossorigin="anonymous"></script>
</body>
</html>
    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDiDrJxXzj2XF3EEQ6E4%2FDHissw3McMcmK2OURchdhSWM5gpWUcp3CT7UtyoWfHpQivzbUiY3oKV1WDCmMFU7MjjbG%2BPn3Y%2BU795uqmaRXkR4VHMzsVXiaeW83VwOARONC3i38dk9s64RXA%2FOQVGBceFlqLnUYWrlLStZSwYma67Gse6oxr5up3CfCGjFc5FM45fTr4%2FXQqEgZv36tfDe29fycW2z6Sfrx6URfUToUgLXSZMioAbFQKYVy9LIbwXNQi2CfAp3er9dwx8X2cRv3pZUnFeafrypGy9WWWKPH09gnWmLz1l%2F0WN7k2GwRA0QUqtUqo%2FGcl1HO8afWnJU1Az5z0Md0aHJrpAgyhtVq6Z4QrHkp8S7Q97KDVU43ujYgrJWRE%2B6JITwnPVdszWXsbx374eRW4C9YyVm3pNHsCvMjBdF6SXaaX8SLBf%2B9dh1fO7pmb%2BqBiSRtEM74RZItD7fw5JyccH8ZEMwkSXPUldGWzTTLtLL%2Fazz4M1jyUv1mBePgyCYz1u2dkU6YGpraMA%3D";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDiDrJxXzj2XF3EEQ6E4/DHissw3McMcmK2OURchdhSWM5gpWUcp3CT7UtyoWfHpQivzbUiY3oKV1WDCmMFU7MjjbG+Pn3Y+U795uqmaRXkR4VHMzsVXiaeW83VwOARONC3i38dk9s64RXA/OQVGBceFlqLnUYWrlLStZSwYma67Gse6oxr5up3CfCGjFc5FM45fTr4/XQqEgZv36tfDe29fycW2z6Sfrx6URfUToUgLXSZMioAbFQKYVy9LIbwXNQi2CfAp3er9dwx8X2cRv3pZUnFeafrypGy9WWWKPH09gnWmLz1l/0WN7k2GwRA0QUqtUqo/Gcl1HO8afWnJU1Az5z0Md0aHJrpAgyhtVq6Z4QrHkp8S7Q97KDVU43ujYgrJWRE+6JITwnPVdszWXsbx374eRW4C9YyVm3pNHsCvMjBdF6SXaaX8SLBf+9dh1fO7pmb+qBiSRtEM74RZItD7fw5JyccH8ZEMwkSXPUldGWzTTLtLL/azz4M1jyUv1mBePgyCYz1u2dkU6YGpraMA=";
    </script>
    
    <script id="html_notice_dialog_script" src="https://www.genspark.ai/notice_dialog.js"></script>
    